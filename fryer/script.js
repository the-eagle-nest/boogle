const imageUpload=document.getElementById("imageUpload"),fryLevel=document.getElementById("fryLevel"),fryButton=document.getElementById("fryButton"),friedImage=document.getElementById("friedImage"),downloadLink=document.getElementById("downloadLink"),result=document.getElementById("result"),fileInput=document.getElementById("imageUpload"),isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);if(isSafari){let e=document.getElementById("result");e.innerHTML="<h2>Safari is not fully supported yet.</h2> <p>Please use a desktop browser or try Chrome, Firefox, or Edge for the best experience.</p>",e.style.display="block"}const worker=new Worker("image_processing_worker.js");function processImageInChunks(e,t){let r=0;function o(){let t=Math.min(r+5e3,e.data.length);(r=t)<e.data.length&&(updateProgressBar(10),setTimeout(o,0))}setTimeout(o,0)}worker.postMessage({imageData,fryLevel}),worker.onmessage=e=>{e.data},onmessage=e=>{let{imageData:t,fryLevel:r}=e.data,o=processImage(t,r);postMessage(o)};const browseButton=document.querySelector(".btn-primary");function processImage(e,t){console.log("Entered processImage");let r=document.createElement("canvas"),o=r.getContext("2d"),l=new Image;l.onload=()=>{r.width=l.width,r.height=l.height,o.drawImage(l,0,0);let e=t.split("."),a=e.pop(),n=`${e.join(".")}_${fryLevel.value}.${a}`;setTimeout(()=>{friedImage.src=r.toDataURL("image/jpeg",.5),downloadLink.href=friedImage.src,downloadLink.download=n,result.style.display="block",console.log(friedImage.src)},200),applyFilters(o,r.width,r.height)},l.src=e}function updateProgressBar(e){let t=document.getElementById("loading-bar"),r=parseInt(t.style.width,10)||0;r+=e,r=Math.min(r,100),t.style.width=`${r}%`,100===r&&hideProgressBar()}function showProgressBar(){document.getElementById("loading-container").style.display="block"}function hideProgressBar(){document.getElementById("loading-container").style.display="none"}function applyFilters(e,t,r){console.log("Entered applyFilters");let o=e.getImageData(0,0,t,r),l=o.data,a={fried:10,overfried:20,burnt:145,"caught-on-fire":300}[fryLevel.value];for(let n=0;n<l.length;n+=4){for(let i=0;i<3;i++){l[n+i]=255/(1+Math.exp(-a*(l[n+i]/255-.5)));let s="burnt"===fryLevel.value?16:"caught-on-fire"===fryLevel.value?8:32;l[n+i]=Math.floor(l[n+i]/(256/s))*(256/s)}updateProgressBar(40)}let d={fried:.97,overfried:.96,burnt:.95,"caught-on-fire":.94}[fryLevel.value];for(let f=0;f<l.length;f+=4)for(let g=0;g<3;g++)l[f+g]*=d;function $(e,t){let r=e.data,o=e.width,l=e.height,a="overfried"===t?175:340;for(let n=0;n<l;n++)for(let i=0;i<o;i++){let s=a*Math.sin(100*n),d=a*Math.sin(2*i*100),f=Math.floor(i+s),g=Math.floor(n+d);if(f>=0&&f<o&&g>=0&&g<l){let $=(n*o+i)*4,u=(g*o+f)*4;for(let c=0;c<4;c++)r[$+c]=r[u+c]}}updateProgressBar(10)}e.putImageData(o,0,0)}function addNoise(e,t){let r=e.data;for(let o=0;o<r.length;o+=4)for(let l=0;l<3;l++){let a=(Math.random()-.5)*128*t;r[o+l]=Math.min(255,Math.max(0,r[o+l]+a))}updateProgressBar(20),ctx.putImageData(e,0,0)}function compressImage(e,t,r,o){for(let l=0;l<r;l+=o)for(let a=0;a<t;a+=o)compressBlock(e,t,a,l,o);updateProgressBar(20)}function compressBlock(e,t,r,o,l){let a=0,n=0,i=0,s=0;for(let d=0;d<l;d++)for(let f=0;f<l;f++){let g=(t*(o+d)+(r+f))*4;a+=e[g],n+=e[g+1],i+=e[g+2],s++}a=Math.floor(a/s),n=Math.floor(n/s),i=Math.floor(i/s);for(let $=0;$<l;$++)for(let u=0;u<l;u++){let c=(t*(o+$)+(r+u))*4;e[c]=a,e[c+1]=n,e[c+2]=i}if("burnt"===fryLevel.value||"caught-on-fire"===fryLevel.value){let m="caught-on-fire"===fryLevel.value?50:35;addNoise(imageData,m)}ctx.putImageData(imageData,0,0)}function addNoise(e,t){let r=e.data;for(let o=0;o<r.length;o+=4)for(let l=0;l<3;l++){let a=(Math.random()-.5)*128*t;r[o+l]=Math.min(255,Math.max(0,r[o+l]+a))}updateProgressBar(10),ctx.putImageData(e,0,0)}browseButton.addEventListener("click",()=>fileInput.click()),fryButton.addEventListener("click",()=>{console.log("Fry button clicked");let e=imageUpload.files[0];if(e){console.log("File selected");let t=new FileReader;t.onload=function(t){let r=t.target.result;showProgressBar(),processImage(r,e.name)},t.readAsDataURL(e)}});